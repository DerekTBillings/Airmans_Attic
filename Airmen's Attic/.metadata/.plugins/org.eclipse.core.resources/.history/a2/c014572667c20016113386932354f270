package com.billings.controllers;

import java.net.URL;
import java.util.List;
import java.util.ResourceBundle;

import javafx.collections.ObservableList;
import javafx.event.EventTarget;
import javafx.fxml.FXML;
import javafx.fxml.Initializable;
import javafx.scene.control.Button;
import javafx.scene.control.Label;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableView;
import javafx.scene.control.TableView.TableViewSelectionModel;
import javafx.scene.control.cell.PropertyValueFactory;

import com.billings.jdbc.dao.RaffleAdminPageDAO;
import com.billings.jdbc.dao.RaffleAdminPageImpl;
import com.billings.jdbc.dto.Person;
import com.billings.jdbc.dto.RaffleItem;
import com.billings.main.WindowController;
import com.billings.resources.RaffleAdminPageResources;
import com.billings.utils.FXMLFactory;

public class RaffleAdminPageController implements Initializable {
	
	@FXML
	TableView raffleItemTbl;
	@FXML
	TableView peopleInRaffleTbl;

	@FXML
	TableColumn raffleItemColumn;
	@FXML
	TableColumn personInRaffleName;
	@FXML
	TableColumn personInRaffleContact;

	@FXML
	Label raffleItemDescription;
	@FXML
	Label winnerLbl;
	@FXML
	Label winnerNameLbl;
	@FXML
	Label winnerName;
	@FXML
	Label winnerContactLbl;
	@FXML
	Label winnerContact;

	@FXML
	Button cancelBtn;
	@FXML
	Button raffleItemBtn;
	@FXML
	Button itemReceivedBtn;
	
	
	@Override
	public void initialize(URL arg0, ResourceBundle arg1) {
		setupNodesWithInitialText();
		
		RaffleAdminPageResources.raffleItemsInTbl = getRaffleItemTblItems();
		
		loadRaffleItems();
		linkRaffleItemWithTbl();
		populateRaffleItemTbl();
		
		setupRaffleItemTblClick();
	}
	
	private void setupNodesWithInitialText() {
		raffleItemColumn.setText(RaffleAdminPageResources.RAFFLE_ITEM_COLUMN);
		personInRaffleName.setText(RaffleAdminPageResources.PERSON_IN_RAFFLE_NAME);
		personInRaffleContact.setText(RaffleAdminPageResources.PERSON_IN_RAFFLE_CONTACT);
		winnerLbl.setText(RaffleAdminPageResources.WINNER_LBL);
		winnerNameLbl.setText(RaffleAdminPageResources.WINNER_NAME_LBL);
		winnerContactLbl.setText(RaffleAdminPageResources.WINNER_CONTACT_LBL);
		cancelBtn.setText(RaffleAdminPageResources.CANCEL_BTN);
		raffleItemBtn.setText(RaffleAdminPageResources.RAFFLE_ITEM_BTN);
		itemReceivedBtn.setText(RaffleAdminPageResources.ITEM_RECEIVED_BTN);
	}
	
	private void loadRaffleItems() {
		RaffleAdminPageDAO dao = new RaffleAdminPageImpl();
		
		RaffleAdminPageResources.raffleItems = dao.getRaffleItems(false);
	}
	
	private void linkRaffleItemWithTbl() {
		raffleItemColumn.setCellValueFactory(
			new PropertyValueFactory<RaffleItem, String>("name")
		);
	}
	
	private ObservableList getRaffleItemTblItems() {
		return raffleItemTbl.getItems();
	}
	
	private void populateRaffleItemTbl() {		
		RaffleAdminPageResources.raffleItemsInTbl.addAll(
				RaffleAdminPageResources.raffleItems);
		
		RaffleAdminPageResources.addNewRaffleItemSlot();
	}
	
	private void setupRaffleItemTblClick() {
		raffleItemTbl.setOnMouseClicked(e -> {
			EventTarget target = e.getTarget();
			
			if (isTargetAColumn(target)) {
				TableViewSelectionModel<RaffleItem> selectedItem = raffleItemTbl.getSelectionModel();
				RaffleItem selectedRow = selectedItem.getSelectedItem();
				
				String raffleName = selectedRow.getName();
				if (raffleName.equals("New")) {
					createNewRaffleItem();
				} else {
					populatePeopleInRaffle(selectedRow);
				}
			}
		});
	}

	private boolean isTargetAColumn(EventTarget target) {
		String targetText = target.toString();
		
		boolean isCorrectTarget = false;
		
		if (targetText.startsWith("Text") ||
				targetText.startsWith("TableColumn$1$1")) {
			isCorrectTarget = true;
		}
		
		return isCorrectTarget;
	}
	
	private void createNewRaffleItem() {
		WindowController.createPopupWindow(
			FXMLFactory.getNewRaffleItemPage());
	} 
	
	private void populatePeopleInRaffle(RaffleItem selectedItem) {
		RaffleAdminPageDAO dao = new RaffleAdminPageImpl();
		
		int raffleItemId = selectedItem.getRaffleId();
		
		List<Person> peopleInRaffle = dao.getPeopleInRaffleById(raffleItemId);
		
		loadPeopleInRaffleTable(peopleInRaffle);
	}
	
	private void loadPeopleInRaffleTable(List<Person> peopleInRaffe) {
		personInRaffleName.setCellValueFactory(
			new PropertyValueFactory<Person, String>("lastName")
		);
		
		personInRaffleContact.setCellValueFactory(
			new PropertyValueFactory<Person, String>("cellPhone")
		);
		
		ObservableList<Person> peopleInRaffle = peopleInRaffleTbl.getItems();
		peopleInRaffle.addAll(peopleInRaffle);
	}
	
	

}
